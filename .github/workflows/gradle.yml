name: Build & Release

on:
  push:
    branches: [master]
    paths-ignore:
      - "*.md"

jobs:
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    permissions: write-all

    env:
      MAKE_LATEST: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: corretto
      - name: Read version from gradle.properties
        id: version
        run: |
          # thanks to Catppuccin Addon
          VERSION=$(grep "^mod_version" gradle.properties | cut -d '=' -f2 | tr -d '[:space:]')
          MC_VERSION=$(grep "^minecraft_version" gradle.properties | cut -d '=' -f2 | tr -d '[:space:]')
          TAG_NAME="mc${MC_VERSION}-v${VERSION}"
          RELEASE_NAME="${MC_VERSION}-${VERSION} build"

          echo "tag=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "release_name=$RELEASE_NAME" >> "$GITHUB_OUTPUT"
      - name: Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.version.outputs.tag }} -m "Release ${{ steps.version.outputs.release_name }}"
          git push origin ${{ steps.version.outputs.tag }}
      - name: Grant execute permissions to gradlew
        run: chmod +x ./gradlew
      - name: Build addon
        run: ./gradlew build
      - name: Remove *-dev.jar
        run: rm ./build/libs/*-dev.jar || true
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "${{ steps.version.outputs.release_name }} ${{ github.run_number }}"
          files: build/libs/*.jar
          make_latest: ${{ env.MAKE_LATEST }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
